package famigo

import (
	"fmt"
	"strings"
)

type dbgCursor struct {
	x, y int
	w, h int
}

func (c *dbgCursor) newline() {
	c.x = 0
	c.y += 8
	if c.y >= c.h {
		c.y = 0
	}
}

func (c *dbgCursor) advanceChar() {
	c.x += 8
	if c.x >= c.w {
		c.newline()
	}
}

func (c *dbgCursor) clearLine(screen []byte) {
	startX, startY := c.x, c.y
	for c.y == startY {
		c.writeChar(screen, ' ')
	}
	c.x, c.y = startX, startY
}

func (c *dbgCursor) writeString(screen []byte, str string) {
	for _, char := range strings.ToUpper(str) {
		if char == '\x00' {
			continue
		}
		c.writeChar(screen, char)
	}
}

func (c *dbgCursor) writeChar(screen []byte, char rune) {
	if char == '\n' {
		c.newline()
	} else {
		fontChr, ok := dbgFont[char]
		if !ok {
			fmt.Printf("MISSING CHAR %q\n", char)
			fontChr = dbgFont['?']
		}
		for i := 0; i < 7; i++ {
			line := screen[(c.y+i)*c.w*4+c.x*4:]
			chrLine := fontChr[i*7 : i*7+7]
			for j := 0; j < 7; j++ {
				col := byte(0)
				if chrLine[j] == 1 {
					col = 0xff
				}
				line[j*4+0], line[j*4+1] = col, col
				line[j*4+2], line[j*4+3] = col, col
			}
		}
		c.advanceChar()
	}
}

var dbgFont = map[rune][7 * 7]byte{
	'0': {
		1, 1, 1, 1, 1, 1, 1,
		1, 0, 0, 0, 0, 1, 1,
		1, 0, 0, 0, 1, 0, 1,
		1, 0, 0, 1, 0, 0, 1,
		1, 0, 1, 0, 0, 0, 1,
		1, 1, 0, 0, 0, 0, 1,
		1, 1, 1, 1, 1, 1, 1,
	},
	'1': {
		0, 0, 0, 1, 0, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
	},
	'2': {
		1, 1, 1, 1, 1, 1, 1,
		0, 0, 0, 0, 0, 0, 1,
		0, 0, 0, 0, 0, 0, 1,
		1, 1, 1, 1, 1, 1, 1,
		1, 0, 0, 0, 0, 0, 0,
		1, 0, 0, 0, 0, 0, 0,
		1, 1, 1, 1, 1, 1, 1,
	},
	'3': {
		1, 1, 1, 1, 1, 1, 1,
		0, 0, 0, 0, 0, 0, 1,
		0, 0, 0, 0, 0, 0, 1,
		1, 1, 1, 1, 1, 1, 1,
		0, 0, 0, 0, 0, 0, 1,
		0, 0, 0, 0, 0, 0, 1,
		1, 1, 1, 1, 1, 1, 1,
	},
	'4': {
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 1, 1, 1, 1, 1, 1,
		0, 0, 0, 0, 0, 0, 1,
		0, 0, 0, 0, 0, 0, 1,
		0, 0, 0, 0, 0, 0, 1,
	},
	'5': {
		1, 1, 1, 1, 1, 1, 1,
		1, 0, 0, 0, 0, 0, 0,
		1, 0, 0, 0, 0, 0, 0,
		1, 1, 1, 1, 1, 1, 1,
		0, 0, 0, 0, 0, 0, 1,
		0, 0, 0, 0, 0, 0, 1,
		1, 1, 1, 1, 1, 1, 1,
	},
	'6': {
		1, 1, 1, 1, 1, 1, 1,
		1, 0, 0, 0, 0, 0, 0,
		1, 0, 0, 0, 0, 0, 0,
		1, 1, 1, 1, 1, 1, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 1, 1, 1, 1, 1, 1,
	},
	'7': {
		1, 1, 1, 1, 1, 1, 1,
		0, 0, 0, 0, 0, 1, 0,
		0, 0, 0, 0, 1, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
		0, 0, 1, 0, 0, 0, 0,
		0, 1, 0, 0, 0, 0, 0,
		1, 0, 0, 0, 0, 0, 0,
	},
	'8': {
		1, 1, 1, 1, 1, 1, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 1, 1, 1, 1, 1, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 1, 1, 1, 1, 1, 1,
	},
	'9': {
		1, 1, 1, 1, 1, 1, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 1, 1, 1, 1, 1, 1,
		0, 0, 0, 0, 0, 0, 1,
		0, 0, 0, 0, 0, 0, 1,
		0, 0, 0, 0, 0, 0, 1,
	},
	'A': {
		1, 1, 1, 1, 1, 1, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 1, 1, 1, 1, 1, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
	},
	'B': {
		1, 1, 1, 1, 1, 1, 0,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 1, 1, 1, 1, 1, 0,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 1, 1, 1, 1, 1, 0,
	},
	'C': {
		1, 1, 1, 1, 1, 1, 1,
		1, 0, 0, 0, 0, 0, 0,
		1, 0, 0, 0, 0, 0, 0,
		1, 0, 0, 0, 0, 0, 0,
		1, 0, 0, 0, 0, 0, 0,
		1, 0, 0, 0, 0, 0, 0,
		1, 1, 1, 1, 1, 1, 1,
	},
	'D': {
		1, 1, 1, 1, 1, 0, 0,
		1, 0, 0, 0, 0, 1, 0,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 1, 0,
		1, 1, 1, 1, 1, 0, 0,
	},
	'E': {
		1, 1, 1, 1, 1, 1, 1,
		1, 0, 0, 0, 0, 0, 0,
		1, 0, 0, 0, 0, 0, 0,
		1, 1, 1, 1, 1, 1, 1,
		1, 0, 0, 0, 0, 0, 0,
		1, 0, 0, 0, 0, 0, 0,
		1, 1, 1, 1, 1, 1, 1,
	},
	'F': {
		1, 1, 1, 1, 1, 1, 1,
		1, 0, 0, 0, 0, 0, 0,
		1, 0, 0, 0, 0, 0, 0,
		1, 1, 1, 1, 1, 1, 1,
		1, 0, 0, 0, 0, 0, 0,
		1, 0, 0, 0, 0, 0, 0,
		1, 0, 0, 0, 0, 0, 0,
	},
	'G': {
		1, 1, 1, 1, 1, 1, 1,
		1, 0, 0, 0, 0, 0, 0,
		1, 0, 0, 0, 0, 0, 0,
		1, 0, 0, 1, 1, 1, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 1, 1, 1, 1, 1, 1,
	},
	'H': {
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 1, 1, 1, 1, 1, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
	},
	'I': {
		1, 1, 1, 1, 1, 1, 1,
		0, 0, 0, 1, 0, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
		1, 1, 1, 1, 1, 1, 1,
	},
	'J': {
		1, 1, 1, 1, 1, 1, 1,
		0, 0, 0, 1, 0, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
		1, 0, 0, 1, 0, 0, 0,
		1, 1, 1, 1, 0, 0, 0,
	},
	'K': {
		1, 0, 0, 0, 0, 1, 0,
		1, 0, 0, 0, 1, 0, 0,
		1, 0, 0, 1, 0, 0, 0,
		1, 1, 1, 0, 0, 0, 0,
		1, 0, 0, 1, 0, 0, 0,
		1, 0, 0, 0, 1, 0, 0,
		1, 0, 0, 0, 0, 1, 0,
	},
	'L': {
		1, 0, 0, 0, 0, 0, 0,
		1, 0, 0, 0, 0, 0, 0,
		1, 0, 0, 0, 0, 0, 0,
		1, 0, 0, 0, 0, 0, 0,
		1, 0, 0, 0, 0, 0, 0,
		1, 0, 0, 0, 0, 0, 0,
		1, 1, 1, 1, 1, 1, 1,
	},
	'M': {
		1, 1, 1, 1, 1, 1, 1,
		1, 0, 0, 1, 0, 0, 1,
		1, 0, 0, 1, 0, 0, 1,
		1, 0, 0, 1, 0, 0, 1,
		1, 0, 0, 1, 0, 0, 1,
		1, 0, 0, 1, 0, 0, 1,
		1, 0, 0, 1, 0, 0, 1,
	},
	'N': {
		1, 0, 0, 0, 0, 0, 1,
		1, 1, 0, 0, 0, 0, 1,
		1, 0, 1, 0, 0, 0, 1,
		1, 0, 0, 1, 0, 0, 1,
		1, 0, 0, 0, 1, 0, 1,
		1, 0, 0, 0, 0, 1, 1,
		1, 0, 0, 0, 0, 0, 1,
	},
	'O': {
		1, 1, 1, 1, 1, 1, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 1, 1, 1, 1, 1, 1,
	},
	'P': {
		1, 1, 1, 1, 1, 1, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 1, 1, 1, 1, 1, 1,
		1, 0, 0, 0, 0, 0, 0,
		1, 0, 0, 0, 0, 0, 0,
		1, 0, 0, 0, 0, 0, 0,
	},
	'Q': {
		1, 1, 1, 1, 1, 1, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 1, 0, 1,
		1, 0, 0, 0, 0, 1, 0,
		1, 1, 1, 1, 1, 0, 1,
	},
	'R': {
		1, 1, 1, 1, 1, 1, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 1, 1, 1, 1, 1, 1,
		1, 0, 0, 0, 1, 0, 0,
		1, 0, 0, 0, 0, 1, 0,
		1, 0, 0, 0, 0, 0, 1,
	},
	'S': {
		1, 1, 1, 1, 1, 1, 1,
		1, 0, 0, 0, 0, 0, 0,
		1, 0, 0, 0, 0, 0, 0,
		1, 1, 1, 1, 1, 1, 1,
		0, 0, 0, 0, 0, 0, 1,
		0, 0, 0, 0, 0, 0, 1,
		1, 1, 1, 1, 1, 1, 1,
	},
	'T': {
		1, 1, 1, 1, 1, 1, 1,
		0, 0, 0, 1, 0, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
	},
	'U': {
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 1, 1, 1, 1, 1, 1,
	},
	'V': {
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		0, 1, 0, 0, 0, 1, 0,
		0, 0, 1, 0, 1, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
	},
	'W': {
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 0, 0, 0, 1,
		1, 0, 0, 1, 0, 0, 1,
		1, 0, 0, 1, 0, 0, 1,
		1, 0, 0, 1, 0, 0, 1,
		1, 1, 1, 1, 1, 1, 1,
	},
	'X': {
		1, 0, 0, 0, 0, 0, 1,
		0, 1, 0, 0, 0, 1, 0,
		0, 0, 1, 0, 1, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
		0, 0, 1, 0, 1, 0, 0,
		0, 1, 0, 0, 0, 1, 0,
		1, 0, 0, 0, 0, 0, 1,
	},
	'Y': {
		1, 0, 0, 0, 0, 0, 1,
		0, 1, 0, 0, 0, 1, 0,
		0, 0, 1, 0, 1, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
	},
	'Z': {
		1, 1, 1, 1, 1, 1, 1,
		0, 0, 0, 0, 0, 1, 0,
		0, 0, 0, 0, 1, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
		0, 0, 1, 0, 0, 0, 0,
		0, 1, 0, 0, 0, 0, 0,
		1, 1, 1, 1, 1, 1, 1,
	},
	' ': {
		0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0,
	},
	'.': {
		0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0,
		1, 1, 0, 0, 0, 0, 0,
		1, 1, 0, 0, 0, 0, 0,
	},
	',': {
		0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0,
		0, 1, 0, 0, 0, 0, 0,
		1, 0, 0, 0, 0, 0, 0,
	},
	'?': {
		1, 1, 1, 1, 1, 1, 1,
		0, 0, 0, 0, 0, 0, 1,
		0, 0, 0, 0, 0, 0, 1,
		0, 0, 0, 1, 1, 1, 1,
		0, 0, 0, 1, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
	},
	':': {
		1, 1, 0, 0, 0, 0, 0,
		1, 1, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0,
		1, 1, 0, 0, 0, 0, 0,
		1, 1, 0, 0, 0, 0, 0,
	},
	'!': {
		0, 0, 0, 1, 0, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
	},
	'/': {
		0, 0, 0, 0, 0, 0, 1,
		0, 0, 0, 0, 0, 1, 0,
		0, 0, 0, 0, 1, 0, 0,
		0, 0, 0, 1, 0, 0, 0,
		0, 0, 1, 0, 0, 0, 0,
		0, 1, 0, 0, 0, 0, 0,
		1, 0, 0, 0, 0, 0, 0,
	},
}
